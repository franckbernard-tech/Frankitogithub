{
  "name": "üîß URGENCE - R√©parer SSH + D√©ployer Bot",
  "nodes": [
    {
      "parameters": {},
      "name": "START",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\nconst log = [];\n\ntry {\n  log.push('üîß √âTAPE 1 : R√©paration SSH...');\n  \n  // V√©rifier le fichier SSH config actuel\n  const currentConfig = execSync('cat /etc/ssh/sshd_config | grep \"^Port\"', { encoding: 'utf-8' }).trim();\n  log.push('üìã Configuration SSH actuelle: ' + currentConfig);\n  \n  // Remettre SSH sur port 22\n  log.push('üîÑ Remise sur port 22...');\n  execSync('sed -i \"s/^Port 2222/#Port 22/g\" /etc/ssh/sshd_config', { encoding: 'utf-8' });\n  execSync('sed -i \"s/^#Port 22/Port 22/g\" /etc/ssh/sshd_config', { encoding: 'utf-8' });\n  \n  // V√©rifier la nouvelle config\n  const newConfig = execSync('cat /etc/ssh/sshd_config | grep \"Port\"', { encoding: 'utf-8' }).trim();\n  log.push('‚úÖ Nouvelle configuration: ' + newConfig);\n  \n  // Red√©marrer SSH\n  log.push('üîÑ Red√©marrage service SSH...');\n  try {\n    execSync('systemctl restart sshd', { encoding: 'utf-8', timeout: 5000 });\n    log.push('‚úÖ SSH red√©marr√© (systemctl)');\n  } catch (e) {\n    execSync('service ssh restart', { encoding: 'utf-8', timeout: 5000 });\n    log.push('‚úÖ SSH red√©marr√© (service)');\n  }\n  \n  // V√©rifier que SSH √©coute sur port 22\n  const sshStatus = execSync('ss -tlnp | grep :22 || netstat -tlnp | grep :22', { encoding: 'utf-8' }).trim();\n  log.push('‚úÖ SSH √©coute maintenant sur port 22');\n  log.push('üìä ' + sshStatus);\n  \n  return {\n    success: true,\n    step: 'ssh_repaired',\n    log: log,\n    ssh_status: sshStatus\n  };\n  \n} catch (error) {\n  log.push('‚ùå ERREUR: ' + error.message);\n  return {\n    success: false,\n    error: error.message,\n    log: log\n  };\n}"
      },
      "name": "1Ô∏è‚É£ R√©parer SSH",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst { execSync } = require('child_process');\nconst log = [];\n\ntry {\n  log.push('ü§ñ √âTAPE 2 : D√©ploiement du bot...');\n  \n  // Cr√©er le r√©pertoire\n  log.push('üìÅ Cr√©ation /root/frankito-bot/');\n  execSync('mkdir -p /root/frankito-bot', { encoding: 'utf-8' });\n  \n  // Cr√©er bot.js\n  log.push('üìù Cr√©ation bot.js...');\n  const botCode = `const { Telegraf } = require('telegraf');\n\nconst BOT_TOKEN = '8510817329:AAE72JsuTE_r-sAnclrNN5APE1wIDeKKGXE';\nconst bot = new Telegraf(BOT_TOKEN);\n\nbot.start((ctx) => {\n  ctx.reply('üëã Bienvenue sur Frankito Bot!\\\\n\\\\nCommandes:\\\\n/start - Afficher ce message\\\\n/ping - Tester le bot');\n});\n\nbot.command('ping', (ctx) => {\n  ctx.reply('üèì Pong !');\n});\n\nbot.catch((err) => console.error('‚ùå Erreur:', err));\nbot.launch();\nconsole.log('‚úÖ Frankito Bot d√©marr√©!');\nprocess.once('SIGINT', () => bot.stop('SIGINT'));\nprocess.once('SIGTERM', () => bot.stop('SIGTERM'));\n`;\n  \n  fs.writeFileSync('/root/frankito-bot/bot.js', botCode, { encoding: 'utf-8' });\n  log.push('‚úÖ bot.js cr√©√© (' + botCode.length + ' bytes)');\n  \n  // Cr√©er package.json\n  log.push('üì¶ Cr√©ation package.json...');\n  const pkg = { name: 'frankito-bot', version: '1.0.0', main: 'bot.js', dependencies: { telegraf: '^4.12.2' } };\n  fs.writeFileSync('/root/frankito-bot/package.json', JSON.stringify(pkg, null, 2));\n  \n  // Installer d√©pendances\n  log.push('üì• Installation telegraf (30-60s)...');\n  const npmOut = execSync('cd /root/frankito-bot && npm install --production 2>&1', { \n    encoding: 'utf-8',\n    timeout: 90000\n  });\n  log.push('‚úÖ D√©pendances install√©es');\n  \n  // Arr√™ter ancien processus PM2\n  log.push('üîÑ Nettoyage PM2...');\n  try {\n    execSync('pm2 delete frankito-bot', { encoding: 'utf-8' });\n    log.push('‚ö†Ô∏è Ancien processus supprim√©');\n  } catch (e) {\n    log.push('‚ÑπÔ∏è Pas de processus existant');\n  }\n  \n  // Lancer avec PM2\n  log.push('üöÄ Lancement PM2...');\n  const pm2Out = execSync('cd /root/frankito-bot && pm2 start bot.js --name frankito-bot', {\n    encoding: 'utf-8',\n    timeout: 15000\n  });\n  log.push('‚úÖ Bot lanc√© avec PM2');\n  \n  // Sauvegarder PM2\n  log.push('üíæ Configuration auto-start...');\n  execSync('pm2 save', { encoding: 'utf-8' });\n  log.push('‚úÖ PM2 sauvegard√©');\n  \n  // R√©cup√©rer statut\n  const statusJson = execSync('pm2 jlist', { encoding: 'utf-8' });\n  const processes = JSON.parse(statusJson);\n  const bot = processes.find(p => p.name === 'frankito-bot');\n  \n  if (!bot) throw new Error('Bot non trouv√© dans PM2');\n  \n  // R√©cup√©rer logs\n  let logs = '';\n  try {\n    logs = execSync('pm2 logs frankito-bot --lines 5 --nostream 2>&1', { \n      encoding: 'utf-8',\n      timeout: 5000\n    });\n  } catch (e) {\n    logs = 'Logs non imm√©diatement disponibles';\n  }\n  \n  log.push('üéâ D√âPLOIEMENT TERMIN√â!');\n  \n  return {\n    success: true,\n    step: 'bot_deployed',\n    status: bot.pm2_env.status,\n    pid: bot.pid,\n    uptime_seconds: Math.round((Date.now() - bot.pm2_env.pm_uptime) / 1000),\n    memory_mb: Math.round(bot.monit.memory / 1024 / 1024),\n    cpu: bot.monit.cpu,\n    restarts: bot.pm2_env.restart_time,\n    logs: logs,\n    log: log\n  };\n  \n} catch (error) {\n  log.push('‚ùå ERREUR: ' + error.message);\n  return {\n    success: false,\n    error: error.message,\n    log: log\n  };\n}"
      },
      "name": "2Ô∏è‚É£ D√©ployer Bot",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.success }}",
              "value2": "true"
            }
          ]
        }
      },
      "name": "Succ√®s?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            { "name": "üéâ R√âSULTAT", "value": "SUCC√àS COMPLET" },
            { "name": "‚úÖ SSH", "value": "R√©par√© et sur port 22" },
            { "name": "ü§ñ Bot Status", "value": "={{ $json.status }}" },
            { "name": "üÜî PID", "value": "={{ $json.pid }}" },
            { "name": "‚è±Ô∏è Uptime", "value": "={{ $json.uptime_seconds }} secondes" },
            { "name": "üíæ RAM", "value": "={{ $json.memory_mb }} MB" },
            { "name": "‚ö° CPU", "value": "={{ $json.cpu }}%" },
            { "name": "üîÑ Restarts", "value": "={{ $json.restarts }}" },
            { "name": "üìú Logs", "value": "={{ $json.logs }}" },
            { "name": "üìã Log installation", "value": "={{ $json.log.join('\\n') }}" },
            { "name": "üí° SSH Access", "value": "ssh root@72.62.232.53 -p 22" }
          ]
        }
      },
      "name": "‚úÖ SUCC√àS",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "values": {
          "string": [
            { "name": "‚ùå R√âSULTAT", "value": "√âCHEC" },
            { "name": "‚ö†Ô∏è Erreur", "value": "={{ $json.error }}" },
            { "name": "üìã Log", "value": "={{ $json.log.join('\\n') }}" }
          ]
        }
      },
      "name": "‚ùå √âCHEC",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1050, 400]
    }
  ],
  "connections": {
    "START": {
      "main": [[{ "node": "1Ô∏è‚É£ R√©parer SSH", "type": "main", "index": 0 }]]
    },
    "1Ô∏è‚É£ R√©parer SSH": {
      "main": [[{ "node": "2Ô∏è‚É£ D√©ployer Bot", "type": "main", "index": 0 }]]
    },
    "2Ô∏è‚É£ D√©ployer Bot": {
      "main": [[{ "node": "Succ√®s?", "type": "main", "index": 0 }]]
    },
    "Succ√®s?": {
      "main": [
        [{ "node": "‚úÖ SUCC√àS", "type": "main", "index": 0 }],
        [{ "node": "‚ùå √âCHEC", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {}
}
