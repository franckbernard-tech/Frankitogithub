{
  "name": "üéØ INSTALLATION COMPL√àTE - Frankito Bot",
  "nodes": [
    {
      "parameters": {},
      "name": "START",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst { execSync } = require('child_process');\n\nconst log = [];\nconst addLog = (msg) => { log.push(msg); console.log(msg); };\n\ntry {\n  // √âTAPE 1 : Cr√©er le r√©pertoire\n  addLog('üìÅ Cr√©ation du r√©pertoire /root/frankito-bot/');\n  execSync('mkdir -p /root/frankito-bot', { encoding: 'utf-8' });\n  addLog('‚úÖ R√©pertoire cr√©√©');\n\n  // √âTAPE 2 : Cr√©er bot.js\n  addLog('üìù Cr√©ation de bot.js...');\n  const botCode = `const { Telegraf } = require('telegraf');\n\nconst BOT_TOKEN = '8510817329:AAE72JsuTE_r-sAnclrNN5APE1wIDeKKGXE';\nconst bot = new Telegraf(BOT_TOKEN);\n\n// Commande /start\nbot.start((ctx) => {\n  ctx.reply('üëã Bienvenue sur Frankito Bot!\\\\n\\\\nCommandes disponibles:\\\\n/start - Afficher ce message\\\\n/ping - Tester le bot');\n});\n\n// Commande /ping\nbot.command('ping', (ctx) => {\n  ctx.reply('üèì Pong !');\n});\n\n// Gestion des erreurs\nbot.catch((err) => {\n  console.error('‚ùå Erreur Bot:', err);\n});\n\n// Lancement\nbot.launch();\nconsole.log('‚úÖ Frankito Bot d√©marr√©!');\n\n// Graceful shutdown\nprocess.once('SIGINT', () => bot.stop('SIGINT'));\nprocess.once('SIGTERM', () => bot.stop('SIGTERM'));\n`;\n\n  fs.writeFileSync('/root/frankito-bot/bot.js', botCode, { encoding: 'utf-8' });\n  addLog('‚úÖ bot.js cr√©√© (' + botCode.length + ' bytes)');\n\n  // √âTAPE 3 : Cr√©er package.json\n  addLog('üì¶ Cr√©ation de package.json...');\n  const packageJson = {\n    name: 'frankito-bot',\n    version: '1.0.0',\n    description: 'Bot Telegram Frankito',\n    main: 'bot.js',\n    scripts: { start: 'node bot.js' },\n    dependencies: { telegraf: '^4.12.2' }\n  };\n  fs.writeFileSync('/root/frankito-bot/package.json', JSON.stringify(packageJson, null, 2), { encoding: 'utf-8' });\n  addLog('‚úÖ package.json cr√©√©');\n\n  // √âTAPE 4 : Installer les d√©pendances\n  addLog('üì• Installation de telegraf (peut prendre 30s)...');\n  const npmInstall = execSync('cd /root/frankito-bot && npm install --production', { \n    encoding: 'utf-8',\n    timeout: 60000\n  });\n  addLog('‚úÖ telegraf install√©');\n\n  // √âTAPE 5 : Arr√™ter PM2 existant si pr√©sent\n  addLog('üîÑ V√©rification PM2...');\n  try {\n    execSync('pm2 delete frankito-bot', { encoding: 'utf-8' });\n    addLog('‚ö†Ô∏è Ancien processus supprim√©');\n  } catch (e) {\n    addLog('‚ÑπÔ∏è Aucun processus existant');\n  }\n\n  // √âTAPE 6 : Lancer avec PM2\n  addLog('üöÄ Lancement avec PM2...');\n  const pm2Start = execSync('cd /root/frankito-bot && pm2 start bot.js --name frankito-bot', {\n    encoding: 'utf-8',\n    timeout: 15000\n  });\n  addLog('‚úÖ Bot lanc√© avec PM2');\n\n  // √âTAPE 7 : Sauvegarder PM2\n  addLog('üíæ Configuration PM2 pour d√©marrage auto...');\n  execSync('pm2 save', { encoding: 'utf-8' });\n  addLog('‚úÖ PM2 sauvegard√©');\n\n  // √âTAPE 8 : R√©cup√©rer le statut\n  addLog('üìä R√©cup√©ration du statut...');\n  const pm2Status = execSync('pm2 jlist', { encoding: 'utf-8', timeout: 5000 });\n  const processes = JSON.parse(pm2Status);\n  const botProcess = processes.find(p => p.name === 'frankito-bot');\n\n  if (!botProcess) {\n    throw new Error('Bot non trouv√© dans PM2');\n  }\n\n  // √âTAPE 9 : R√©cup√©rer les logs\n  addLog('üìú R√©cup√©ration des logs...');\n  let logs = '';\n  try {\n    logs = execSync('pm2 logs frankito-bot --lines 5 --nostream', { \n      encoding: 'utf-8',\n      timeout: 5000\n    });\n  } catch (e) {\n    logs = 'Logs non disponibles imm√©diatement';\n  }\n\n  addLog('üéâ INSTALLATION TERMIN√âE!');\n\n  return {\n    success: true,\n    status: botProcess.pm2_env.status,\n    pid: botProcess.pid,\n    uptime: Math.round((Date.now() - botProcess.pm2_env.pm_uptime) / 1000),\n    memory: Math.round(botProcess.monit.memory / 1024 / 1024),\n    cpu: botProcess.monit.cpu,\n    restarts: botProcess.pm2_env.restart_time,\n    logs: logs,\n    full_log: log,\n    timestamp: new Date().toISOString()\n  };\n\n} catch (error) {\n  addLog('‚ùå ERREUR: ' + error.message);\n  return {\n    success: false,\n    error: error.message,\n    stack: error.stack,\n    full_log: log\n  };\n}"
      },
      "name": "Installation Compl√®te",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.success }}",
              "value2": "true"
            }
          ]
        }
      },
      "name": "Succ√®s?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            { "name": "üéâ STATUT", "value": "INSTALLATION R√âUSSIE" },
            { "name": "ü§ñ Status", "value": "={{ $json.status }}" },
            { "name": "üÜî PID", "value": "={{ $json.pid }}" },
            { "name": "‚è±Ô∏è Uptime", "value": "={{ $json.uptime }} secondes" },
            { "name": "üíæ RAM", "value": "={{ $json.memory }} MB" },
            { "name": "‚ö° CPU", "value": "={{ $json.cpu }}%" },
            { "name": "üîÑ Restarts", "value": "={{ $json.restarts }}" },
            { "name": "üìú Logs (5 derni√®res lignes)", "value": "={{ $json.logs }}" },
            { "name": "üìã Log complet", "value": "={{ $json.full_log.join('\\n') }}" }
          ]
        }
      },
      "name": "‚úÖ SUCC√àS",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "values": {
          "string": [
            { "name": "‚ùå STATUT", "value": "√âCHEC" },
            { "name": "‚ö†Ô∏è Erreur", "value": "={{ $json.error }}" },
            { "name": "üìã Log complet", "value": "={{ $json.full_log.join('\\n') }}" },
            { "name": "üîç Stack", "value": "={{ $json.stack }}" }
          ]
        }
      },
      "name": "‚ùå √âCHEC",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [850, 400]
    }
  ],
  "connections": {
    "START": {
      "main": [[{ "node": "Installation Compl√®te", "type": "main", "index": 0 }]]
    },
    "Installation Compl√®te": {
      "main": [[{ "node": "Succ√®s?", "type": "main", "index": 0 }]]
    },
    "Succ√®s?": {
      "main": [
        [{ "node": "‚úÖ SUCC√àS", "type": "main", "index": 0 }],
        [{ "node": "‚ùå √âCHEC", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {}
}
